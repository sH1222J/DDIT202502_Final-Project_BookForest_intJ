<?xml version="1.0" encoding="UTF-8"?>
<!--
    QNA (1:1 문의) 및 QNA_REPLY (문의 답변) 테이블을 위한 MyBatis 매퍼입니다.
    사용자 문의 및 답변과 관련된 CRUD 작업을 위한 SQL 쿼리를 정의합니다.
-->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bookforest.project_bookforest_intj.qna.repository.QnaRepository">

    <!-- QNA 테이블의 컬럼과 QnaVO 매핑 -->
    <resultMap id="qnaResultMap" type="com.bookforest.project_bookforest_intj.qna.vo.QnaVO">
        <id property="qnaNo" column="QNA_NO"/>
        <result property="aeId" column="AE_ID"/>
        <result property="qnaTitle" column="QNA_TITLE"/>
        <result property="qnaYmd" column="QNA_YMD"/>
        <result property="qnaContent" column="QNA_CONTENT"/>
        <result property="uaNo" column="UA_NO"/>
        <result property="ccgI001" column="CCG_I001"/>
    </resultMap>

    <!-- QNA_REPLY 테이블의 컬럼과 QnaReplyVO 매핑 -->
    <resultMap id="qnaReplyResultMap" type="com.bookforest.project_bookforest_intj.qna.vo.QnaReplyVO">
        <id property="reNo" column="RE_NO"/>
        <result property="reContent" column="RE_CONTENT"/>
        <result property="userId" column="USER_ID"/>
        <result property="qnaNo" column="QNA_NO"/>
        <result property="aeId" column="AE_ID"/>
    </resultMap>

    <!-- 1. 새로운 문의내역 등록 -->
    <!-- 
        - id="save": QnaRepository의 save 메소드와 매핑됩니다.
        - <selectKey>: INSERT가 실행되기 전에 시퀀스(QNA_SEQ)에서 다음 값을 가져와 qnaNo 프로퍼티에 설정합니다.
        - SYSDATE: DB서버의 현재 시간을 사용하여 작성일을 저장합니다.
        - CCG_I001='1': 초기 상태를 '답변대기'로 설정합니다.
    -->
    <insert id="save" parameterType="com.bookforest.project_bookforest_intj.qna.entity.Qna">
        <selectKey keyProperty="qnaNo" resultType="string" order="BEFORE">
            SELECT QNA_SEQ.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO QNA (
            QNA_NO, AE_ID, QNA_TITLE, QNA_YMD, QNA_CONTENT, CCG_I001
        ) VALUES (
            #{qnaNo}, #{aeId}, #{qnaTitle}, SYSDATE, #{qnaContent}, '1'
        )
    </insert>

    <!-- 2. 모든 문의내역 조회 (최신순) -->
    <select id="findAll" resultMap="qnaResultMap">
        SELECT
            AE_ID, QNA_NO, QNA_TITLE, QNA_YMD, QNA_CONTENT, UA_NO, CCG_I001
        FROM QNA
        ORDER BY QNA_YMD DESC
    </select>

    <!-- 3. 특정 사용자의 문의내역 조회 -->
    <select id="selectQnaListByAeId" parameterType="string" resultMap="qnaResultMap">
        SELECT
            AE_ID, QNA_NO, QNA_TITLE, QNA_YMD, QNA_CONTENT, UA_NO, CCG_I001
        FROM QNA
        WHERE AE_ID = #{aeId}
        ORDER BY QNA_YMD DESC
    </select>

    <!-- 4. 특정 문의내역 상세 조회 -->
    <select id="selectQnaDetail" parameterType="string" resultMap="qnaResultMap">
        SELECT
            AE_ID, QNA_NO, QNA_TITLE, QNA_YMD, QNA_CONTENT, UA_NO, CCG_I001
        FROM QNA
        WHERE QNA_NO = #{qnaNo}
    </select>

    <!-- 5. 문의내역 수정 (제목, 내용, 첨부파일 번호) -->
    <update id="updateQna" parameterType="com.bookforest.project_bookforest_intj.qna.vo.QnaVO">
        UPDATE QNA
        SET
            QNA_TITLE = #{qnaTitle},
            QNA_CONTENT = #{qnaContent},
            UA_NO = #{uaNo}
        WHERE QNA_NO = #{qnaNo}
    </update>

    <!-- 6. 문의내역 상태 업데이트 (예: 답변 완료로 변경) -->
    <update id="updateQnaStatus" parameterType="map">
        UPDATE QNA
        SET
            CCG_I001 = #{ccgI001}
        WHERE QNA_NO = #{qnaNo}
    </update>

    <!-- 7. 문의내역 삭제 -->
    <delete id="deleteQna" parameterType="string">
        DELETE FROM QNA
        WHERE QNA_NO = #{qnaNo}
    </delete>

    <!-- 8. 문의 답변 등록 -->
    <insert id="insertQnaReply" parameterType="com.bookforest.project_bookforest_intj.qna.vo.QnaReplyVO">
        INSERT INTO QNA_REPLY (
            RE_NO, RE_CONTENT, USER_ID, QNA_NO, AE_ID
        ) VALUES (
            #{reNo}, #{reContent}, #{userId}, #{qnaNo}, #{aeId}
        )
    </insert>

    <!-- 9. 특정 문의에 대한 답변 조회 -->
    <select id="selectQnaRepliesByQnaNo" parameterType="string" resultMap="qnaReplyResultMap">
        SELECT
            RE_NO, RE_CONTENT, USER_ID, QNA_NO, AE_ID
        FROM QNA_REPLY
        WHERE QNA_NO = #{qnaNo}
        ORDER BY RE_NO ASC
    </select>

    <!-- 10. 문의 답변 수정 -->
    <update id="updateQnaReply" parameterType="com.bookforest.project_bookforest_intj.qna.vo.QnaReplyVO">
        UPDATE QNA_REPLY
        SET
            RE_CONTENT = #{reContent},
            USER_ID = #{userId}
        WHERE RE_NO = #{reNo}
    </update>

    <!-- 11. 문의 답변 삭제 -->
    <delete id="deleteQnaReply" parameterType="string">
        DELETE FROM QNA_REPLY
        WHERE RE_NO = #{reNo}
    </delete>

</mapper>